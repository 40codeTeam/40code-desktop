apihost="https://service-dq726wx5-1302921490.sh.apigw.tencentcs.com/",window.waitRequest={},window.scratch={search:e=>{let t=$("#mdl")[0].children;for(let o=1;o<t.length;o++)console.log(t[o]),-1==$(t[o]).attr("text1").indexOf(e)?$(t[o]).hide():$(t[o]).show()},alertLoadExt:async()=>{let t='请选择：<br>\n    <div class="mdui-list" id="mdl">\n    <div class="mdui-textfield mdui-textfield-floating-label">\n      <label class="mdui-textfield-label">名称/作者</label>\n      <input class="mdui-textfield-input" oninput="window.scratch.search(this.value)" onporpertychange="window.scratch.search(this.value)" onchange="window.scratch.search(this.value)"/>\n    </div>\n    ',o=await(await fetch(apihost+"work/ext")).json();window.scratch.extList=o;for(let e=0;e<o.length;e++){let n=o[e];t+=`\n      <label class="mdui-list-item mdui-ripple" id="itemn${e}" text1="${n.name+"-"+n.author}">\n        <div class="mdui-checkbox">\n          <input name="extSelect" type="checkbox" ${vm.extensionManager._loadedExtensions.get(n.extId)?"checked":""}/>\n          <i class="mdui-checkbox-icon"></i>\n        </div>\n        <div class="mdui-list-item-content" >${n.name}<span class="mdui-float-right" style="color:#777;font-size:10px;">${n.author}</span></div>\n      </label>\n        `}t+="</div>",mdui.alert(t,(async()=>{for(let t=0;t<o.length;t++)if($('[name="extSelect"]')[t].checked)try{vm.extensionManager._loadedExtensions.get(o[t].extId)||vm.extensionManager.loadExtensionURL("https://abc.520gxx.com/ext/"+o[t].extId+".js")}catch(t){console.log(e)}}))},uploadExt:async()=>{var e=document.createElement("input");e.type="file",e.accept=".js",e.click();var t=setInterval((()=>{if(e.files.length){var o=new FileReader;clearInterval(t);try{o.readAsText(e.files[0]),o.onload=function(e){var t=new Blob([e.target.result]);vm.extensionManager.loadExtensionURL(URL.createObjectURL(t))}}catch(e){resolve(""),console.log(e)}}}),50)}};var temp2={apihost:"https://service-dq726wx5-1302921490.sh.apigw.tencentcs.com/"};function dataURLToBlob(e){for(var t=e.split(","),o=t[0].match(/:(.*?);/)[1],n=atob(t[1]),a=n.length,i=new Uint8Array(a);a--;)i[a]=n.charCodeAt(a);return new Blob([i],{type:o})}function setCookie(e,t,o){console.log("设置cookie");var n=new Date;n.setTime(n.getTime()+24*o*60*60*1e3);var a="expires="+n.toGMTString();document.cookie=e+"="+t+"; "+a}function getCookie(e){for(var t=e+"=",o=document.cookie.split(";"),n=0;n<o.length;n++){var a=o[n].trim();if(0==a.indexOf(t)){let o=a.substring(t.length,a.length);if("token"==e)try{v.$data.token=o}catch(e){}return o}}return""}function getuserinfo(){get({url:"user/myinfo"},(function(e){userdetail=e.data,console.log("获取信息成功",e),"undefined"!=typeof v&&(v.$data.detail=e.data)}))}function getuserinfosync(){return new Promise((function(e){get({url:"user/myinfo"},(function(t){userdetail=t.data,console.log("获取信息成功",t),"undefined"!=typeof v&&(v.$data.detail=t.data),e(userdetail)}))}))}function getworkinfosync(e){return new Promise((function(t){get({url:"work/info",data:{id:e}},(function(e){t(e.data)}))}))}function get(e,t,o){let n=e.data;if(n||(n={}),e.p){if(waitRequest[e.p])return;waitRequest[e.p]=1}n.token=getCookie("token"),$.ajax({url:apihost+e.url,data:n,type:"get",headers:{onreferer:location.pathname,href:location.href},success:function(o){console.log(o),o.redirect?location.href=o.redirect:("exit"==o.cz&&(document.cookie="token=; expires=Thu, 01 Jan 1970 00:00:00 GMT",console.log("清除cookie")),e.p&&delete waitRequest[e.p],t&&t(o))},error:function(t){e.p&&delete waitRequest[e.p],console.log(t),o?o():alert("服务器或网络错误")}})}function post(e,t,o){let n=e.data;if(e.p){if(waitRequest[e.p])return;waitRequest[e.p]=1}n||(n={}),$.ajax({url:apihost+e.url+"?token="+getCookie("token"),data:JSON.stringify(n),type:"post",contentType:"application/json",headers:{onreferer:location.pathname,href:location.href},success:function(o){console.log(o),o.redirect?location.href=o.redirect:((o.msg||o.errmsg)&&alert(o.msg||o.errmsg),"exit"==o.cz&&(document.cookie="token=; expires=Thu, 01 Jan 1970 00:00:00 GMT",console.log("清除cookie")),e.p&&delete waitRequest[e.p],t&&t(o))},error:function(t){e.p&&delete waitRequest[e.p],console.log(t),o?o():alert("服务器或网络错误")}})}function downloadFileByBlob(e,t="file"){let o=window.URL.createObjectURL(e),n=document.createElement("a");n.download=t||"defaultName",n.style.display="none",n.href=o,document.body.appendChild(n),n.click(),document.body.removeChild(n)}function dlp(){window.scratch.getProjectFile((e=>{downloadFileByBlob(e)}))}function savecover(e){function t(t){let o=t.data[2][0][1].Key.split("/");e&&e(o[o.length-1]),setTimeout((()=>{$("#setCover").text("设置当前截图为封面"),$("#saveProject").text("保存")}),5e3)}$("#b").hide(),$("#setCover").text("正在保存封面……"),vm.postIOData("video",{forceTransparentPreview:!0}),vm.renderer.requestSnapshot((e=>{vm.postIOData("video",{forceTransparentPreview:!1}),function(e){let o=new FormData;$("#setCover").text("正在保存封面文件"),o.append("image",e),$.ajax({url:apihost+"work/uploads?token="+getCookie("token"),method:"POST",data:o,cache:!1,contentType:!1,processData:!1,dataType:"json",success:function(e){if(1!=e.code)return t(),void alert("保存失败");t(e),$("#setCover").text("封面保存成功")},error:function(){t(),alert("保存失败")}})}(dataURLToBlob(e))})),vm.renderer.draw()}async function saveproject(e,t,o){console.log("自定义按钮1"),console.log("分享按钮");let n=[];var a=vm.assets;$("#scratch").css("opacity","0"),$("#view").show(),$("#dlp").show(),$("#i2").hide;let i=function(e){let t=e;if(t){for(let e=0;e<a.length;e++)if(a[e].assetId==t.split(".")[0]){t=e;break}return t=new Blob([a[t].data],{type:a[t].assetType.contentType}),console.log(URL.createObjectURL(t)),t}};function r(){$("#scratch").css("opacity","1"),$("#view").hide(),$("#dlp").hide();try{$("#app > div > div > div > div.gui_menu-bar-position_6ejza.menu-bar_menu-bar_1gLUp.box_box_tWy-0 > div.menu-bar_main-menu_EyCGw > div:nth-child(4) > span:nth-child(3) > div")[0].text("保存")}catch(e){console.log(e)}setTimeout((()=>{$("#setCover").text("设置当前截图为封面"),$("#saveProject").text("保存")}),5e3),t&&t()}function l(){let t=new FormData;$("#saveProject").text("正在保存作品文件……"),t.append("work",new Blob([vm.toJSON()])),$.ajax({url:apihost+"work/upload?token="+getCookie("token")+"&id="+(e||workinfo.id),method:"POST",data:t,cache:!1,contentType:!1,processData:!1,dataType:"json",headers:{onreferer:location.pathname,href:location.href,publish:o||void 0},success:function(e){if(1!=e.code)return r(),void alert("保存失败");r(),$(window).unbind("beforeunload"),window.onbeforeunload=null;let t="";try{t=$(".input_input-form_2EIqD.project-title-input_title-field_13MIs.menu-bar_title-field-growable_2DAmE").val()}catch(e){}o&&(location.href="/#page=workinfo&publish=1&id="+workinfo.id+"&name="+t),$("#saveProject").text("作品保存成功"),window.onbeforeunload=function(){}},error:function(){r(),alert("保存失败")}})}function s(e){if(!i(n[e]))return e+1>=n.length?($("#b").hide(),l()):s(e+1),void console.log("被迫退出");if(i(n[e]).size>5767168)return console.log("尺寸过大",e,n[e],"跳过"),mdui.snackbar("含有>5.5MB的素材，已跳过"),void s(++e);let t=new FormData,o=i(n[e]);t.append("image",o),console.log(0),$.ajax({url:apihost+"work/uploads?token="+getCookie("token"),method:"POST",data:t,cache:!1,contentType:!1,processData:!1,dataType:"json",success:function(t){if(1!=t.code)return r(),void alert("保存失败");vm.assets&&n[e]&&vm.assets[n[e]]&&(vm.assets[n[e]].clean=!0),console.log(vm.assets,n[e]),$("#saveProject").text("保存素材中…… "+parseInt((e+1)/n.length*1e4)/100+"%"),e+1>=n.length?($("#b").hide(),l()):s(e+1)},error:function(){r(),alert("保存失败"),console.log("保存失败")}})}function c(e){return new Promise((t=>{setTimeout((()=>t()),e)}))}$("#i2").hide(),$("#saveProject").text("正在检查素材列表……");for(let e of a)e.clean||n.push(e.assetId+"."+e.dataFormat);let d=await new Promise((async e=>{console.log("fuckyou",n);let t=function(e,t){for(var o=new Array,n=0,a=e.length/t,i=0;i<a;i++){for(var r=new Array,l=0;l<t&&(r[l]=e[n++],n!=e.length);l++);o[i]=r}return o}(n,1e3),o=[],a=0;t.length||e([]);for(let n=0;n<t.length;n++)post({url:"work/imagelist",data:{list:t[n]}},(n=>{a++,console.log(n),o=o.concat(n.data),a==t.length&&e(o)}),(t=>{e(null)})),n!=t.length-1&&await c(4e3)}));d?(n=d,console.log(n),n.length?($("#saveProject").text("正在保存素材……"),$("#b").show(),s(0)):l()):(alert("作品素材检查失败，请重试，多次失败请联系QQ:3274235903查看原因"),r())}function save(e){try{$("#app > div > div > div > div.gui_menu-bar-position_6ejza.menu-bar_menu-bar_1gLUp.box_box_tWy-0 > div.menu-bar_main-menu_EyCGw > div:nth-child(4) > span:nth-child(3) > div")[0].text("保存中……")}catch(e){console.log(e)}if(workinfo.isauthor)saveproject(null,null,e);else{try{$("#app > div > div > div > div.gui_menu-bar-position_6ejza.menu-bar_menu-bar_1gLUp.box_box_tWy-0 > div.menu-bar_main-menu_EyCGw > div.menu-bar_menu-bar-item_264qQ > span:nth-child(2) > div")[0].text("改编中……")}catch(e){console.log(e)}post({url:"work/new",p:"newwork"},(function(t){saveproject(t.info.insertId,(function(){location.href="/scratch#id="+t.info.insertId,location.reload()}),e)}))}}function dataURLToBlob(e){for(var t=e.split(","),o=t[0].match(/:(.*?);/)[1],n=atob(t[1]),a=n.length,i=new Uint8Array(a);a--;)i[a]=n.charCodeAt(a);return new Blob([i],{type:o})}