var userdetail,waitRequest={},myCaptcha;function getQueryString(e){let t=new RegExp("(^|&)"+e+"=([^&]*)(&|$)","i");if(window.location.hash.indexOf("#")<0)return null;let o=window.location.hash.split("#")[1].match(t);return null!=o?decodeURIComponent(o[2]):null}function setCookie(e,t,o){console.log("设置cookie");var n=new Date;n.setTime(n.getTime()+24*o*60*60*1e3);var i="expires="+n.toGMTString()+"  path=/;";if(o<0){i="expires="+n.toGMTString()+"  path=/;";document.cookie=e+"="+t+"; "+i;i="expires="+n.toGMTString()+" domain=.40code.com; path=/;";document.cookie=e+"="+t+"; "+i}document.cookie=e+"="+t+"; "+i}function getCookie(e){for(var t=e+"=",o=document.cookie.split(";"),n=0;n<o.length;n++){var i=o[n].trim();if(0==i.indexOf(t)){return i.substring(t.length,i.length)}}return""}function getuserinfo(){get({url:"user/myinfo"},(function(e){userdetail=e.data,console.log("获取信息成功",e)}))}function getuserinfosync(){return new Promise((function(e){get({url:"user/myinfo"},(function(t){userdetail=t.data,console.log("获取信息成功",t),e(userdetail)}))}))}function getworkinfosync(e){return new Promise((function(t){get({url:"work/info",data:{id:e}},(function(e){t(e.data)}))}))}function get(e,t,o,n){let i=e.data;if("string"==typeof e&&(e={url:e}),i||(i={}),e.p){if(waitRequest[e.p])return;waitRequest[e.p]=1}i.token=getCookie("token"),$.ajax({url:apihost+e.url,data:i,type:n||"get",headers:{onreferer:location.pathname,href:location.href},success:function(o){console.log(o),o.redirect?location.href=o.redirect:("exit"==o.cz&&(document.cookie="token=; expires=Thu, 01 Jan 1970 00:00:00 GMT",document.cookie="token=0; expires=Thu, 01 Jan 1970 00:00:00 GMT; domain=.40code.com; path=/;",document.cookie="token=0; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/;",console.log("清除cookie")),e.p&&delete waitRequest[e.p],t&&t(o))},error:function(t){if(e.p&&delete waitRequest[e.p],console.log(t),o?o(t):alert(t&&t.responseJSON&&(t.responseJSON.msg||t.responseJSON.errmsg)||"服务器或网络错误"),0==t.status&&"error"==t.statusText)return window.qf||(window.qf=0),window.qf++,void("/"==location.pathname&&3==window.qf&&fetch("/111").then((e=>{e.status&&(location.href="#page=qf")})));t.responseJSON.redirect&&(location.href=t.responseJSON.redirect)}})}function post(e,t,o,n){let i=e.data;if(e.p){if(waitRequest[e.p])return;waitRequest[e.p]=1}i||(i={}),$.ajax({url:apihost+e.url+"?token="+getCookie("token"),data:JSON.stringify(i),type:n||"post",contentType:"application/json",headers:{onreferer:location.pathname,href:location.href},success:function(o){console.log(o),e.p&&delete waitRequest[e.p],(o.msg||o.errmsg)&&alert(o.msg||o.errmsg),"exit"==o.cz&&(document.cookie="token=; expires=Thu, 01 Jan 1970 00:00:00 GMT",console.log("清除cookie")),o.redirect?location.href=o.redirect:t&&t(o)},error:function(t){if(e.p&&delete waitRequest[e.p],console.log(t),o?o(t):alert(t&&t.responseJSON&&(t.responseJSON.msg||t.responseJSON.errmsg)||"服务器或网络错误"),0==t.status&&"error"==t.statusText)return window.qf||(window.qf=0),window.qf++,void("/"==location.pathname&&3==window.qf&&fetch("/111").then((e=>{e.status&&(location.href="#page=qf")})));t.responseJSON.redirect&&(location.href=t.responseJSON.redirect)}})}function downloadFileByBlob(e,t="file"){let o=window.URL.createObjectURL(e),n=document.createElement("a");n.download=t||"defaultName",n.style.display="none",n.href=o,document.body.appendChild(n),n.click(),document.body.removeChild(n)}function dlp(){window.scratch.getProjectFile((e=>{downloadFileByBlob(e)}))}function savecover(e){function t(t){let o=t.data[2][0][1].Key.split("/");e&&e(o[o.length-1]),setTimeout((()=>{$("#setCover").text("设置当前截图为封面"),$("#save").text("保存")}),5e3)}$("#b").hide(),$("#setCover").text("正在保存封面……"),vm.postIOData("video",{forceTransparentPreview:!0}),vm.renderer.requestSnapshot((e=>{vm.postIOData("video",{forceTransparentPreview:!1}),function(e){let o=new FormData;$("#setCover").text("正在保存封面文件"),o.append("image",e),$.ajax({url:apihost+"work/uploads?token="+getCookie("token"),method:"POST",data:o,cache:!1,contentType:!1,processData:!1,dataType:"json",success:function(e){if(1!=e.code)return t(),void alert("保存失败");t(e),$("#setCover").text("封面保存成功")},error:function(){t(),alert("保存失败")}})}(dataURLToBlob(e))})),vm.renderer.draw()}async function saveproject(e,t,o){console.log("自定义按钮1"),console.log("分享按钮");let n=[];var i=vm.assets;$("#scratch").css("opacity","0"),$("#view").show(),$("#dlp").show(),$("#i2").hide;let r=function(e){let t=e;if(t){for(let e=0;e<i.length;e++)if(i[e].assetId==t.split(".")[0]){t=e;break}return t=new Blob([i[t].data],{type:i[t].assetType.contentType}),console.log(URL.createObjectURL(t)),t}};function a(){$("#scratch").css("opacity","1"),$("#view").hide(),$("#dlp").hide(),setTimeout((()=>{$("#setCover").text("设置当前截图为封面"),$("#save").text("保存")}),5e3),t&&t()}function s(){let t=new FormData;$("#save").text("正在保存作品文件……"),t.append("work",new Blob([vm.toJSON()])),$.ajax({url:apihost+"work/upload?token="+getCookie("token")+"&id="+(e||workinfo.id),method:"POST",data:t,cache:!1,contentType:!1,processData:!1,dataType:"json",headers:{onreferer:location.pathname,href:location.href,publish:o||void 0},success:function(e){if(1!=e.code)return a(),void alert("保存失败");a(),$(window).unbind("beforeunload"),window.onbeforeunload=null;let t="";try{t=$(".input_input-form_2EIqD.project-title-input_title-field_13MIs.menu-bar_title-field-growable_2DAmE").val()}catch(e){}o&&(location.href="/#page=workinfo&publish=1&id="+workinfo.id+"&name="+t),$("#save").text("作品保存成功"),window.onbeforeunload=function(){}},error:function(){a(),alert("保存失败")}})}function l(e){if(!r(n[e]))return e+1>=n.length?($("#b").hide(),s()):l(e+1),void console.log("被迫退出");if(r(n[e]).size>5767168)return console.log("尺寸过大",e,n[e],"跳过"),mdui.snackbar("含有>5.5MB的素材，已跳过"),void l(++e);let t=new FormData,o=r(n[e]);t.append("image",o),console.log(0),$.ajax({url:apihost+"work/uploads?token="+getCookie("token"),method:"POST",data:t,cache:!1,contentType:!1,processData:!1,dataType:"json",success:function(t){if(1!=t.code)return a(),void alert("保存失败");vm.assets&&n[e]&&vm.assets[n[e]]&&(vm.assets[n[e]].clean=!0),console.log(vm.assets,n[e]),$("#save").text("保存素材中…… "+parseInt((e+1)/n.length*1e4)/100+"%"),e+1>=n.length?($("#b").hide(),s()):l(e+1)},error:function(){a(),alert("保存失败"),console.log("保存失败")}})}function c(e){return new Promise((t=>{setTimeout((()=>t()),e)}))}$("#i2").hide();for(let e of i)e.clean||n.push(e.assetId+"."+e.dataFormat);let u=await new Promise((async e=>{console.log("fuckyou",n);let t=function(e,t){for(var o=new Array,n=0,i=e.length/t,r=0;r<i;r++){for(var a=new Array,s=0;s<t&&(a[s]=e[n++],n!=e.length);s++);o[r]=a}return o}(n,1e3),o=[],i=0;t.length||e([]);for(let n=0;n<t.length;n++)post({url:"work/imagelist",data:{list:t[n]}},(n=>{i++,console.log(n),o=o.concat(n.data),i==t.length&&e(o)}),(t=>{e(null)})),n!=t.length-1&&await c(4e3)}));u?(n=u,console.log(n),n.length?($("#save").text("正在保存素材……"),$("#b").show(),l(0)):s()):(alert("作品素材检查失败，请重试，多次失败请联系QQ:3274235903查看原因"),a())}function save(e){try{$("#save").text("保存中……")}catch(e){console.log(e)}if(workinfo.isauthor)saveproject(null,null,e);else{try{$("#save").text("改编中……")}catch(e){console.log(e)}post({url:"work/new",p:"newwork"},(function(t){saveproject(t.info.insertId,(function(){location.href="/scratch#id="+t.info.insertId,location.reload()}),e)}))}}function dataURLToBlob(e){for(var t=e.split(","),o=t[0].match(/:(.*?);/)[1],n=atob(t[1]),i=n.length,r=new Uint8Array(i);i--;)r[i]=n.charCodeAt(i);return new Blob([r],{type:o})}setInterval((()=>{window.qf?window.qf--:window.qf=0}),500),getQueryString("i")&&setCookie("i",getQueryString("i"),3);var apihost="https://service-dq726wx5-1302921490.sh.apigw.tencentcs.com/",mianhost="http://127.0.0.1:5500",scratchhost="https://abc.520gxx.com",id=getQueryString("id"),v=window.getQueryString("v"),temp2={apihost:apihost};if(window.markdownToHtml=e=>{function t(e){const t=e.match(/<img(?:[^>]*\salt="iframe"[^>]*)>/gi);if(t)for(const o of t){const t=/src=["']([^"']+)["']/i,n=o.match(t);if(n){let t=n[1];t=t.replace(/&amp;/g,"&"),console.log(t);const i=/\/BV([a-zA-Z0-9]+)\//i,r=t.match(i);if(t.includes("player.bilibili.com"))newTag=`<iframe src="${t}" allowfullscreen="allowfullscreen" style="\n                      width: min( 100% ,700px );\n                      height: 400px;\n                  " scrolling="no" frameborder="0" sandbox="allow-top-navigation allow-same-origin allow-forms allow-scripts"></iframe>`,e=e.replace(o,newTag);else if(r){const n=r[1];let i="";if(t.includes("www.bilibili.com")){i=`<iframe src="${`//player.bilibili.com/player.html?bvid=${n}&page=1&high_quality=1&danmaku=0`}" allowfullscreen="allowfullscreen" style="\n                          width: min( 100% ,700px );\n                          height: 400px;\n                      " scrolling="no" frameborder="0" sandbox="allow-top-navigation allow-same-origin allow-forms allow-scripts"></iframe>`}e=e.replace(o,i)}}}return e}let o=DOMPurify.sanitize(marked.parse(e));return-1==o.indexOf("iframe")?o:(console.log("问问",o,t(o)),t(o))},window.userAgent=navigator.userAgent.toLowerCase(),window.isElectron=userAgent.indexOf(" electron/")>-1,window.isElectron){var{shell:shell}=eval('require("electron")');window.$=window.jQuery=eval('require("../other/jquery.min.js")'),window.shell=shell}